<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI Pet That Learns My Voice</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 1100px;
    margin: auto;
    padding: 20px;
  }

  h1 { margin-bottom: 5px; }
  .muted { color: #555; }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }

  .card {
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 16px;
  }

  button {
    padding: 10px 14px;
    margin: 6px 6px 6px 0;
    border-radius: 10px;
    border: 1px solid #888;
    cursor: pointer;
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .petStage {
    height: 300px;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    border: 1px solid #ddd;
    border-radius: 12px;
    background: #fff;
  }

  #petImg {
    max-height: 260px;
  }

  .jumpAnim {
    animation: jump 600ms ease-out;
  }

  @keyframes jump {
    0% { transform: translateY(0); }
    40% { transform: translateY(-80px); }
    100% { transform: translateY(0); }
  }

  .sleepDim {
    opacity: 0.7;
    transform: rotate(-3deg);
  }

  .pill {
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 999px;
    padding: 6px 10px;
    margin: 4px;
    font-size: 14px;
  }
</style>
</head>

<body>

<h1>AI Pet That Learns My Voice</h1>
<p class="muted">
Commands: <b>Sit</b>, <b>Jump</b>, <b>Sleep</b>.  
Use headset microphone. Buttons are the backup.
</p>

<div class="grid">

<!-- LEFT -->
<div class="card">
<h2>Controls</h2>

<button id="startBtn">Start Listening</button>
<button id="stopBtn" disabled>Stop</button>

<p class="muted">If it’s noisy, use buttons:</p>
<button onclick="setPet('Sit','Buttons')">Sit</button>
<button onclick="setPet('Jump','Buttons')">Jump</button>
<button onclick="setPet('Sleep','Buttons')">Sleep</button>

<h3>Prediction</h3>
<div id="topResult"></div>
<div id="scores"></div>

<h3>Status</h3>
<div id="status" class="muted">Loading model…</div>

</div>

<!-- RIGHT -->
<div class="card">
<h2>Pet</h2>
<div class="petStage">
  <img id="petImg" src="dog-stand.png" />
</div>
<h3 id="petText">Waiting…</h3>
<p class="muted">Tip: keep mic close to child’s mouth.</p>
</div>

</div>

<!-- ML LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/audio@0.8/dist/teachablemachine-audio.min.js"></script>

<script>
const MODEL_URL = "model/";
const CONFIDENCE_THRESHOLD = 0.80;

let model, recognizer, listening = false;

const statusEl = document.getElementById("status");
const petImg = document.getElementById("petImg");
const petText = document.getElementById("petText");
const topResult = document.getElementById("topResult");
const scores = document.getElementById("scores");

async function loadModel() {
  try {
    model = await tmAudio.load(
      MODEL_URL + "model.json",
      MODEL_URL + "metadata.json"
    );
    statusEl.innerText = "Model loaded. Click Start Listening.";
  } catch (e) {
    statusEl.innerText =
      "Model not found. IMPORTANT: You must run this via a web server (NOT file://).";
    console.error(e);
  }
}

function setPet(action, source) {
  petImg.className = "";
  if (action === "Sit") {
    petImg.src = "dog-sit.png";
    petText.innerText = `Sitting (from ${source})`;
  }
  if (action === "Jump") {
    petImg.src = "dog-jump.png";
    petImg.classList.add("jumpAnim");
    petText.innerText = `Jumping (from ${source})`;
  }
  if (action === "Sleep") {
    petImg.src = "dog-sleep.png";
    petImg.classList.add("sleepDim");
    petText.innerText = `Sleeping (from ${source})`;
  }
}

async function startListening() {
  if (!model || listening) return;

  recognizer = model.createRecognizer();
  await recognizer.listen(async () => {
    const preds = await model.predict(recognizer.getFrequencyData());
    preds.sort((a,b)=>b.probability-a.probability);

    const top = preds[0];
    topResult.innerText =
      `Top: ${top.className} (${Math.round(top.probability*100)}%)`;

    scores.innerHTML = preds.map(p =>
      `<span class="pill">${p.className}: ${Math.round(p.probability*100)}%</span>`
    ).join("");

    if (top.probability > CONFIDENCE_THRESHOLD) {
      setPet(top.className, "Voice");
    }
  },{
    includeSpectrogram: true,
    overlapFactor: 0.5
  });

  listening = true;
  statusEl.innerText = "Listening…";
  startBtn.disabled = true;
  stopBtn.disabled = false;
}

function stopListening() {
  if (recognizer) recognizer.stopListening();
  listening = false;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  statusEl.innerText = "Stopped.";
}

document.getElementById("startBtn").onclick = startListening;
document.getElementById("stopBtn").onclick = stopListening;

loadModel();
</script>

</body>
</html>
