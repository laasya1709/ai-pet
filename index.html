<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Pet That Learns My Voice</title>
  <style>
    :root { --border:#ddd; --muted:#555; }
    body { font-family: Arial, sans-serif; max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    h1 { margin: 0 0 10px 0; font-size: 44px; }
    .muted { color: var(--muted); }
    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
    .card { border:1px solid var(--border); border-radius:14px; padding:14px; flex:1; min-width:320px; }
    .btn { padding:10px 14px; border-radius:10px; border:1px solid #999; background:#f6f6f6; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); margin:4px 6px 0 0; font-size:14px; }
    #status { white-space:pre-wrap; }

    .petStage { height: 300px; display:flex; align-items:flex-end; justify-content:center; border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    #petImg { width: 320px; height:auto; }

    .jumpAnim { animation: jumpBounce 650ms ease-in-out 1; }
    @keyframes jumpBounce {
      0%   { transform: translateY(0); }
      40%  { transform: translateY(-90px); }
      70%  { transform: translateY(0); }
      100% { transform: translateY(0); }
    }

    .sleepDim { opacity: 0.82; filter: brightness(0.95); }
  </style>
</head>
<body>
  <h1>AI Pet That Learns My Voice</h1>
  <p class="muted">Commands: <b>Sit</b>, <b>Jump</b>, <b>Sleep</b>. Use the headset microphone. Buttons are the backup.</p>

  <div class="row">
    <div class="card">
      <h2>Controls</h2>
      <p>
        <button id="btnStart" class="btn">Start Listening</button>
        <button id="btnStop" class="btn" disabled>Stop</button>
      </p>

      <p class="muted">If it’s noisy, use buttons:</p>
      <p>
        <button class="btn btnAction" data-action="Sit">Sit</button>
        <button class="btn btnAction" data-action="Jump">Jump</button>
        <button class="btn btnAction" data-action="Sleep">Sleep</button>
        <button class="btn btnAction" data-action="Stand">Stand</button>
      </p>

      <h3>Live Prediction</h3>
      <div id="top" style="font-size:18px;"></div>
      <div id="scores"></div>

      <h3>Status</h3>
      <div id="status" class="muted">Loading…</div>

      <hr />
      <div class="muted">
        <b>Setup:</b> Put your Teachable Machine exported files in <code>./model/</code>:
        <code>model.json</code>, <code>metadata.json</code>, <code>weights.bin</code>.
      </div>
    </div>

    <div class="card">
      <h2>Pet</h2>
      <div class="petStage">
        <img id="petImg" src="pet-stand.png?v=1" alt="AI Pet" />
      </div>
      <div id="petText" style="font-size:18px; margin-top:8px;">Waiting…</div>
      <p class="muted">Tip: keep the mic close to the child’s mouth.</p>
    </div>
  </div>

  <script>
    // ==========================
    // Robust dependency loader
    // ==========================
    function loadScriptWithFallback(urls, { timeoutMs = 12000 } = {}) {
      return new Promise((resolve, reject) => {
        let idx = 0;

        const tryNext = (lastErr) => {
          if (idx >= urls.length) {
            reject(lastErr || new Error("All script URLs failed"));
            return;
          }

          const url = urls[idx++];
          const s = document.createElement("script");
          s.src = url;
          s.async = true;

          let done = false;
          const timer = setTimeout(() => {
            if (done) return;
            done = true;
            s.remove();
            tryNext(new Error(`Timeout loading: ${url}`));
          }, timeoutMs);

          s.onload = () => {
            if (done) return;
            done = true;
            clearTimeout(timer);
            resolve(url);
          };

          s.onerror = () => {
            if (done) return;
            done = true;
            clearTimeout(timer);
            s.remove();
            tryNext(new Error(`Failed loading: ${url}`));
          };

          document.head.appendChild(s);
        };

        tryNext();
      });
    }

    async function ensureLibrariesLoaded() {
      // If already loaded, skip.
      if (window.tf && window.tmAudio) return;

      // TensorFlow.js
      if (!window.tf) {
        await loadScriptWithFallback([
          "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js",
          "https://unpkg.com/@tensorflow/tfjs@4.20.0/dist/tf.min.js",
          // last resort older stable:
          "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"
        ]);
      }

      // Teachable Machine Audio (THIS is what your Network panel shows failing)
      if (!window.tmAudio) {
        await loadScriptWithFallback([
          // Pin to a specific version (more reliable than floating tags)
          "https://cdn.jsdelivr.net/npm/@teachablemachine/audio@0.8.4/dist/teachablemachine-audio.min.js",
          "https://unpkg.com/@teachablemachine/audio@0.8.4/dist/teachablemachine-audio.min.js",
          // fallback to 0.8 if 0.8.4 is blocked/missing
          "https://cdn.jsdelivr.net/npm/@teachablemachine/audio@0.8/dist/teachablemachine-audio.min.js",
          "https://unpkg.com/@teachablemachine/audio@0.8/dist/teachablemachine-audio.min.js"
        ]);
      }

      // Final sanity check
      if (!window.tmAudio) {
        throw new Error(
          "Teachable Machine Audio library failed to load.\n\n" +
          "Most common cause: adblock / school network filter blocking CDN.\n\n" +
          "Fix:\n" +
          "1) Disable adblock for this site OR allow cdn.jsdelivr.net and unpkg.com\n" +
          "2) Try a different network\n" +
          "3) Hard refresh (Ctrl+Shift+R)"
        );
      }
    }

    // ==========================
    // App logic (your existing logic, made safe)
    // ==========================
    // Cache-buster: use ?v=100 like you're doing, otherwise timestamp
    const V = new URLSearchParams(location.search).get("v") || String(Date.now());

    // Always resolve against current page URL; works on GitHub Pages (/ai-pet/)
    const MODEL_DIR = new URL("model/", window.location.href).toString();
    const MODEL_JSON_URL = `${MODEL_DIR}model.json?v=${encodeURIComponent(V)}`;
    const META_JSON_URL  = `${MODEL_DIR}metadata.json?v=${encodeURIComponent(V)}`;
    const WEIGHTS_URL    = `${MODEL_DIR}weights.bin?v=${encodeURIComponent(V)}`;

    // Stability controls
    const THRESHOLD = 0.82;   // raise if false triggers
    const STREAK_N  = 2;      // require N consecutive hits

    let model, recognizer;
    let isListening = false;
    let lastLabel = null;
    let streak = 0;

    const elTop = document.getElementById("top");
    const elScores = document.getElementById("scores");
    const elStatus = document.getElementById("status");
    const elPetText = document.getElementById("petText");
    const elPetImg = document.getElementById("petImg");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");

    function showStatus(msg) {
      elStatus.textContent = msg;
    }

    function normalizeAction(label) {
      const s = String(label || "").toLowerCase();
      if (s.includes("sit")) return "Sit";
      if (s.includes("jump")) return "Jump";
      if (s.includes("sleep")) return "Sleep";
      if (s.includes("stand")) return "Stand";
      return null;
    }

    function setPet(action, source = "Voice") {
      elPetImg.className = "";
      if (action === "Sit") {
        elPetImg.src = "pet-sit.png?v=" + encodeURIComponent(V);
        elPetText.textContent = `Sitting (from ${source})`;
      } else if (action === "Jump") {
        elPetImg.src = "pet-jump.png?v=" + encodeURIComponent(V);
        void elPetImg.offsetWidth; // retrigger anim
        elPetImg.classList.add("jumpAnim");
        elPetText.textContent = `Jumping (from ${source})`;
      } else if (action === "Sleep") {
        elPetImg.src = "pet-sleep.png?v=" + encodeURIComponent(V);
        elPetImg.classList.add("sleepDim");
        elPetText.textContent = `Sleeping (from ${source})`;
      } else {
        elPetImg.src = "pet-stand.png?v=" + encodeURIComponent(V);
        elPetText.textContent = `Standing (from ${source})`;
      }
    }

    function renderScores(predictions) {
      const sorted = [...predictions].sort((a,b) => b.probability - a.probability);
      const top = sorted[0];
      elTop.textContent = `Top: ${top.className} (${Math.round(top.probability*100)}%)`;
      elScores.innerHTML = sorted.map(p => {
        const pct = Math.round(p.probability * 100);
        return `<span class="pill">${p.className}: ${pct}%</span>`;
      }).join("");
    }

    function considerTrigger(label, prob) {
      const action = normalizeAction(label);
      if (!action || prob < THRESHOLD) {
        lastLabel = null;
        streak = 0;
        return;
      }
      if (action === lastLabel) streak++;
      else { lastLabel = action; streak = 1; }

      if (streak >= STREAK_N) {
        setPet(action, "Voice");
        streak = 0;
        lastLabel = null;
      }
    }

    async function headOrGet(url) {
      // Some hosts behave oddly with HEAD; fallback to GET
      try {
        const r = await fetch(url, { method: "HEAD", cache: "no-store" });
        if (r.ok) return r;
      } catch {}
      return fetch(url, { method: "GET", cache: "no-store" });
    }

    async function verifyModelFiles() {
      if (location.protocol === "file:") {
        throw new Error(
          "You opened this via file://\n\n" +
          "Browsers block loading model files from file://.\n" +
          "Use GitHub Pages or run a local web server."
        );
      }

      const targets = [
        { name: "model.json",    url: MODEL_JSON_URL },
        { name: "metadata.json", url: META_JSON_URL },
        { name: "weights.bin",   url: WEIGHTS_URL }
      ];

      const results = [];
      for (const t of targets) {
        const r = await headOrGet(t.url);
        const len = r.headers.get("content-length");
        results.push(`${t.name}: HTTP ${r.status}${len ? ` (len ${len})` : ""}`);
        if (!r.ok) throw new Error(`Cannot fetch ${t.name} (HTTP ${r.status}).\nURL: ${t.url}`);
      }
      return results;
    }

    async function loadModel() {
      showStatus(
        "Loading libraries…\n\n" +
        "If this hangs, a blocker is stopping the Teachable Machine script."
      );

      await ensureLibrariesLoaded();

      showStatus(
        "Checking model files…\n\n" +
        `MODEL_DIR = ${MODEL_DIR}\n` +
        `model.json = ${MODEL_JSON_URL}\n` +
        `metadata  = ${META_JSON_URL}\n` +
        `weights   = ${WEIGHTS_URL}\n` +
        `cache v   = ${V}\n`
      );

      const checks = await verifyModelFiles();
      console.log("Model file checks:", checks);

      showStatus(
        "Model files OK:\n" + checks.join("\n") + "\n\nLoading model…"
      );

      // tmAudio is guaranteed to exist here
      model = await window.tmAudio.load(MODEL_JSON_URL, META_JSON_URL);

      showStatus(
        "Model loaded.\n\n" +
        "Click Start Listening.\n" +
        "Tip: If mic prompt doesn’t show, check browser permissions for this site."
      );
    }

    async function startListening() {
      try {
        if (!model) await loadModel();
        if (isListening) return;

        recognizer = model.createRecognizer();

        await recognizer.listen(async () => {
          const predictions = await model.predict(recognizer.getFrequencyData());
          renderScores(predictions);
          const top = predictions.reduce((best, p) => p.probability > best.probability ? p : best, predictions[0]);
          considerTrigger(top.className, top.probability);
        }, {
          includeSpectrogram: true,
          probabilityThreshold: 0,
          overlapFactor: 0.5
        });

        isListening = true;
        btnStart.disabled = true;
        btnStop.disabled = false;
        showStatus("Listening… Speak: Sit / Jump / Sleep");
      } catch (e) {
        showStatus(
          "Model not found / cannot load.\n\n" +
          (e?.message || String(e)) +
          "\n\nWhat to do:\n" +
          "1) DevTools → Network: confirm model.json/metadata.json/weights.bin are 200\n" +
          "2) Disable adblock for this site (common cause of tmAudio not loading)\n" +
          "3) Hard refresh (Ctrl+Shift+R) or change URL to ?v=101\n"
        );
        console.error(e);
      }
    }

    async function stopListening() {
      if (!recognizer || !isListening) return;
      recognizer.stopListening();
      isListening = false;
      btnStart.disabled = false;
      btnStop.disabled = true;
      showStatus("Stopped. Click Start Listening.");
    }

    btnStart.addEventListener("click", startListening);
    btnStop.addEventListener("click", stopListening);

    document.querySelectorAll(".btnAction").forEach(btn => {
      btn.addEventListener("click", () => setPet(btn.dataset.action, "Buttons"));
    });

    // Initial state
    setPet("Stand", "Buttons");

    // Quiet preload (won’t throw tmAudio ReferenceError anymore)
    loadModel().catch(err => {
      console.warn(err);
      showStatus("Model not loaded yet. Click Start Listening.");
    });
  </script>
</body>
</html>
